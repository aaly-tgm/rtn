<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SNMPTrapReceiver.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Ant Example</a> &gt; <a href="index.source.html" class="el_package">snmp</a> &gt; <span class="el_source">SNMPTrapReceiver.java</span></div><h1>SNMPTrapReceiver.java</h1><pre class="source lang-java linenums">package snmp;

import org.snmp4j.*;
import org.snmp4j.mp.MPv1;
import org.snmp4j.mp.MPv2c;
import org.snmp4j.mp.MPv3;
import org.snmp4j.security.*;
import org.snmp4j.smi.*;
import org.snmp4j.transport.DefaultTcpTransportMapping;
import org.snmp4j.transport.DefaultUdpTransportMapping;
import org.snmp4j.util.MultiThreadedMessageDispatcher;
import org.snmp4j.util.ThreadPool;

import java.io.IOException;
import java.net.UnknownHostException;
import java.util.Iterator;
import java.util.Vector;

/**
 * @author mchopker
 */
public class SNMPTrapReceiver implements CommandResponder {

    private MultiThreadedMessageDispatcher dispatcher;
<span class="nc" id="L25">    private Snmp snmp = null;</span>
    private Address listenAddress;
    private ThreadPool threadPool;
<span class="nc" id="L28">    private int n = 0;</span>
<span class="nc" id="L29">    private long start = -1;</span>

<span class="nc" id="L31">    public SNMPTrapReceiver() {</span>
<span class="nc" id="L32">    }</span>

    public static void main(String[] args) {
<span class="nc" id="L35">        new SNMPTrapReceiver().run();</span>
<span class="nc" id="L36">    }</span>

    private void run() {
        try {
<span class="nc" id="L40">            init();</span>
<span class="nc" id="L41">            snmp.addCommandResponder(this);</span>
<span class="nc" id="L42">        } catch (Exception ex) {</span>
<span class="nc" id="L43">            ex.printStackTrace();</span>
<span class="nc" id="L44">        }</span>
<span class="nc" id="L45">    }</span>

    private void init() throws UnknownHostException, IOException {
<span class="nc" id="L48">        threadPool = ThreadPool.create(&quot;Trap&quot;, 10);</span>
<span class="nc" id="L49">        dispatcher = new MultiThreadedMessageDispatcher(threadPool,</span>
                new MessageDispatcherImpl());
<span class="nc" id="L51">        listenAddress = GenericAddress.parse(System.getProperty(</span>
                &quot;snmp4j.listenAddress&quot;, &quot;udp:172.16.2.0/162&quot;));
        TransportMapping&lt;?&gt; transport;
<span class="nc bnc" id="L54" title="All 2 branches missed.">        if (listenAddress instanceof UdpAddress) {</span>
<span class="nc" id="L55">            transport = new DefaultUdpTransportMapping(</span>
                    (UdpAddress) listenAddress);
        } else {
<span class="nc" id="L58">            transport = new DefaultTcpTransportMapping(</span>
                    (TcpAddress) listenAddress);
        }
<span class="nc" id="L61">        USM usm = new USM(SecurityProtocols.getInstance(), new OctetString(</span>
<span class="nc" id="L62">                MPv3.createLocalEngineID()), 0);</span>
<span class="nc" id="L63">        usm.setEngineDiscoveryEnabled(true);</span>

<span class="nc" id="L65">        snmp = new Snmp(dispatcher, transport);</span>
<span class="nc" id="L66">        snmp.getMessageDispatcher().addMessageProcessingModel(new MPv1());</span>
<span class="nc" id="L67">        snmp.getMessageDispatcher().addMessageProcessingModel(new MPv2c());</span>
<span class="nc" id="L68">        snmp.getMessageDispatcher().addMessageProcessingModel(new MPv3(usm));</span>
<span class="nc" id="L69">        SecurityModels.getInstance().addSecurityModel(usm);</span>
<span class="nc" id="L70">        snmp.getUSM().addUser(</span>
                new OctetString(&quot;MD5DES&quot;),
                new UsmUser(new OctetString(&quot;MD5DES&quot;), AuthMD5.ID,
                        new OctetString(&quot;UserName&quot;), PrivDES.ID,
                        new OctetString(&quot;PasswordUser&quot;)));
<span class="nc" id="L75">        snmp.getUSM().addUser(new OctetString(&quot;MD5DES&quot;),</span>
                new UsmUser(new OctetString(&quot;MD5DES&quot;), null, null, null, null));

<span class="nc" id="L78">        snmp.listen();</span>
<span class="nc" id="L79">    }</span>

    public void processPdu(CommandResponderEvent event) {
<span class="nc bnc" id="L82" title="All 2 branches missed.">        if (start &lt; 0) {</span>
<span class="nc" id="L83">            start = System.currentTimeMillis() - 1;</span>
        }
<span class="nc" id="L85">        n++;</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if ((n % 100 == 1)) {</span>
<span class="nc" id="L87">            System.out.println(&quot;Processed &quot;</span>
<span class="nc" id="L88">                    + (n / (double) (System.currentTimeMillis() - start))</span>
                    * 1000 + &quot;/s, total=&quot; + n);
        }

<span class="nc" id="L92">        StringBuffer msg = new StringBuffer();</span>
<span class="nc" id="L93">        msg.append(event.toString());</span>
<span class="nc" id="L94">        Vector&lt;? extends VariableBinding&gt; varBinds = event.getPDU()</span>
<span class="nc" id="L95">                .getVariableBindings();</span>
<span class="nc bnc" id="L96" title="All 4 branches missed.">        if (varBinds != null &amp;&amp; !varBinds.isEmpty()) {</span>
<span class="nc" id="L97">            Iterator&lt;? extends VariableBinding&gt; varIter = varBinds.iterator();</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">            while (varIter.hasNext()) {</span>
<span class="nc" id="L99">                VariableBinding var = varIter.next();</span>
<span class="nc" id="L100">                msg.append(var.toString()).append(&quot;;&quot;);</span>
<span class="nc" id="L101">            }</span>
        }
<span class="nc" id="L103">        System.out.println(&quot;Message Received: &quot; + msg.toString());</span>
<span class="nc" id="L104">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>