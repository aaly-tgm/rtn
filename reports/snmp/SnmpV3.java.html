<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SnmpV3.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Ant Example</a> &gt; <a href="index.source.html" class="el_package">snmp</a> &gt; <span class="el_source">SnmpV3.java</span></div><h1>SnmpV3.java</h1><pre class="source lang-java linenums">package snmp;

import org.apache.log4j.Level;
import org.apache.log4j.Logger;
import org.snmp4j.PDU;
import org.snmp4j.ScopedPDU;
import org.snmp4j.Snmp;
import org.snmp4j.TransportMapping;
import org.snmp4j.event.ResponseEvent;
import org.snmp4j.smi.Address;
import org.snmp4j.smi.OID;
import org.snmp4j.smi.VariableBinding;
import org.snmp4j.transport.DefaultTcpTransportMapping;
import org.snmp4j.transport.DefaultUdpTransportMapping;
import org.snmp4j.util.DefaultPDUFactory;
import org.snmp4j.util.TreeEvent;
import org.snmp4j.util.TreeUtils;
import snmp.exceptions.*;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Vector;

/**
 *
 */
public class SnmpV3 implements SnmpManager {
    private Snmp snmp;
    private TransportMapping&lt;? extends Address&gt; transport;
    private Authentication authentication;
    private Mapping mapping;

    /**
     *
     * @param authentication
     * @param mapping
     * @throws WrongTransportProtocolException
     * @throws WrongAuthenticationException
     * @throws WrongSnmpVersionException
     */
<span class="nc" id="L43">    public SnmpV3(Authentication authentication, Mapping mapping) throws WrongTransportProtocolException, WrongAuthenticationException, WrongSnmpVersionException {</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">        if (authentication instanceof USMAuthentication) {</span>
<span class="nc" id="L45">            this.authentication = authentication;</span>
<span class="nc" id="L46">            this.mapping = mapping;</span>
            try {
<span class="nc bnc" id="L48" title="All 2 branches missed.">                if (authentication.getTransportProtocol().equalsIgnoreCase(&quot;UDP&quot;)) {</span>
<span class="nc" id="L49">                    transport = new DefaultUdpTransportMapping();</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">                } else if (authentication.getTransportProtocol().equalsIgnoreCase(&quot;TCP&quot;)) {</span>
<span class="nc" id="L51">                    transport = new DefaultTcpTransportMapping();</span>
                } else {
<span class="nc" id="L53">                    throw new WrongTransportProtocolException();</span>
                }
<span class="nc" id="L55">            } catch (IOException e) {</span>
<span class="nc" id="L56">                System.err.println(e.getMessage());</span>
<span class="nc" id="L57">            }</span>
<span class="nc" id="L58">            snmp = new Snmp(transport);</span>
<span class="nc" id="L59">            snmp.getUSM().addUser(((USMAuthentication) authentication).getUsmUser());</span>
        } else
<span class="nc" id="L61">            throw new WrongAuthenticationException(&quot;USMAuthentication has to be used!&quot;);</span>
<span class="nc" id="L62">    }</span>

    /**
     * The method getAsString(Oid oid) is using the @see SnmpManager#get to get a String value of the specified OID.
     *
     * @param oid - the requested OID
     * @return - a String with the result from the specified OID
     * @throws SNMPTimeOutException - will be thrown if a timeout with request happens
     * @throws snmp.exceptions.OIDDoesNotExistsException - will be thrown if the specified OID does not exist
     * @throws PDURequestFailedException - will be thrown if an error occurs within the request
     */
    public String getAsString(OID oid) throws SNMPTimeOutException,
            PDURequestFailedException, OIDDoesNotExistsException {
        // extract the response PDU (could be null if timed out)
<span class="nc" id="L76">        VariableBinding ret = get(new OID[]{oid}).get(0);</span>
<span class="nc" id="L77">        String response = ret.getVariable().toString();</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">        if (response.equals(&quot;noSuchObject&quot;))</span>
<span class="nc" id="L79">            throw new OIDDoesNotExistsException();</span>
<span class="nc" id="L80">        return response;</span>
    }

    /**
     * The method get can be specified with an Array of requested OIDs. A Vector with elements of the subclass VariableBinding will be returned.
     * OID requested from the method GET can only return a value. Therefore the OIDd must be a scalar and not a branch.
     *
     * @param oids - the requested OIDs
     * @return - a Vector with VariableBindings
     * @throws SNMPTimeOutException - will be thrown if a timeout with request happens
     * @throws PDURequestFailedException - will be thrown if an error occurs within the request
     * @see org.snmp4j.smi.VariableBinding
     */
    public Vector&lt;? extends VariableBinding&gt; get(OID[] oids)
            throws SNMPTimeOutException, PDURequestFailedException {
<span class="nc" id="L95">        ResponseEvent responseEvent = null;</span>
<span class="nc" id="L96">        Vector&lt;? extends VariableBinding&gt; vbs = null;</span>
        try {
            // send the PDU
<span class="nc" id="L99">            responseEvent = snmp.send(createPDU(PDU.GET, oids), authentication.getTarget());</span>
<span class="nc" id="L100">            Logger.getLogger(SnmpManager.class.getName()).log(Level.INFO,</span>
<span class="nc" id="L101">                    responseEvent.toString());</span>
<span class="nc" id="L102">        } catch (IOException e) {</span>
<span class="nc" id="L103">            System.err.println(e.getMessage());</span>
<span class="nc" id="L104">        }</span>
        // extract the response PDU (could be null if timed out)
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (responseEvent != null) {</span>
<span class="nc" id="L107">            PDU responsePDU = responseEvent.getResponse();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">            if (checkResponsePDU(responsePDU))</span>
<span class="nc" id="L109">                vbs = responsePDU.getVariableBindings();</span>
<span class="nc" id="L110">        } else {</span>
<span class="nc" id="L111">            throw new SNMPTimeOutException();</span>
        }

<span class="nc" id="L114">        return vbs;</span>
    }

    /**
     * This method creates the requst and puts it in an PDU object. This object will be returnd and used from Methods such as get,walk and getnext.
     *
     * @param type - the type of the response, possible are PDU.GET,PDU.GETNEXT, PDU.GETBULK
     * @param oids - the requested OIDs
     * @return - the request PDU
     * @see org.snmp4j.ScopedPDU
     */
    public PDU createPDU(int type, OID[] oids) {
        // create the PDU
<span class="nc" id="L127">        PDU requestPDU = new ScopedPDU();</span>
<span class="nc" id="L128">        requestPDU.setType(type);</span>
        // put the oid you want to get
<span class="nc bnc" id="L130" title="All 2 branches missed.">        for (OID oid : oids) {</span>
<span class="nc" id="L131">            requestPDU.add(new VariableBinding(oid));</span>
        }
<span class="nc" id="L133">        return requestPDU;</span>
    }

    /**
     *
     * @param oids
     * @return
     * @throws SNMPTimeOutException
     * @throws PDURequestFailedException
     */
    public Vector&lt;? extends VariableBinding&gt; getNext(OID[] oids)
            throws SNMPTimeOutException, PDURequestFailedException {
<span class="nc" id="L145">        ResponseEvent responseEvent = null;</span>
<span class="nc" id="L146">        Vector&lt;? extends VariableBinding&gt; vbs = null;</span>
        try {


            // send the PDU
<span class="nc" id="L151">            responseEvent = snmp.send(createPDU(PDU.GETNEXT, oids), authentication.getTarget());</span>
<span class="nc" id="L152">            Logger.getLogger(SnmpManager.class.getName()).log(Level.INFO,</span>
<span class="nc" id="L153">                    responseEvent.toString());</span>
<span class="nc" id="L154">        } catch (IOException e) {</span>
<span class="nc" id="L155">            System.err.println(e.getMessage());</span>
<span class="nc" id="L156">        }</span>
        // extract the response PDU (could be null if timed out)
<span class="nc bnc" id="L158" title="All 2 branches missed.">        if (responseEvent != null) {</span>
<span class="nc" id="L159">            PDU responsePDU = responseEvent.getResponse();</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">            if (checkResponsePDU(responsePDU))</span>
<span class="nc" id="L161">                vbs = responsePDU.getVariableBindings();</span>
<span class="nc" id="L162">        } else {</span>
<span class="nc" id="L163">            throw new SNMPTimeOutException();</span>
        }
<span class="nc" id="L165">        return vbs;</span>
    }

    /**
     * This method returns true or false, which depend on the response PDU.
     * If the response PDU is not null and don't have an error, true will be returned.
     *
     * @param responsePDU the responsePDU, which will be checked for errors.
     * @return - true if no error was invoked else false.
     * @throws PDURequestFailedException - If an error occurred in the response PDU.
     * @throws SNMPTimeOutException      - If a timeout occured
     * @see org.snmp4j.PDU
     */
    public boolean checkResponsePDU(PDU responsePDU)
            throws PDURequestFailedException, SNMPTimeOutException {
<span class="nc bnc" id="L180" title="All 2 branches missed.">        if (responsePDU != null)</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">            if (responsePDU.getErrorStatus() == PDU.noError)</span>
<span class="nc" id="L182">                return true;</span>
            else
<span class="nc" id="L184">                throw new PDURequestFailedException(responsePDU);</span>
        else
<span class="nc" id="L186">            throw new SNMPTimeOutException(&quot;Timeout: No Response from &quot;</span>
<span class="nc" id="L187">                    + authentication.getAddress());</span>
    }

    /**
     * This method needs a valid root OID to return a VariableBinding list with the sub entities.
     *
     * @param rootID - The root OID
     * @return - a list containing VariableBinding
     */
    public List&lt;VariableBinding&gt; getSubtree(OID rootID) throws TreeEventException {
<span class="nc" id="L197">        TreeUtils treeUtils = new TreeUtils(snmp, new DefaultPDUFactory());</span>
<span class="nc" id="L198">        treeUtils.setMaxRepetitions(Integer.MAX_VALUE);</span>
<span class="nc" id="L199">        List&lt;TreeEvent&gt; events = treeUtils.getSubtree(authentication.getTarget(), rootID);</span>

        // Get snmpwalk result.
<span class="nc" id="L202">        List&lt;VariableBinding&gt; varBindings = new ArrayList&lt;VariableBinding&gt;();</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">        for (TreeEvent event : events) {</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">            if (event != null) {</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">                if (event.isError())</span>
<span class="nc" id="L206">                    throw new TreeEventException(&quot;oid [&quot; + rootID + &quot;] &quot; + event.getErrorMessage());</span>
<span class="nc" id="L207">                Collections.addAll(varBindings, event.getVariableBindings());</span>
            }
<span class="nc" id="L209">        }</span>
<span class="nc" id="L210">        return varBindings;</span>
    }

    /**
     * @return - the mapping Object
     */
    public Mapping getMapping() {
<span class="nc" id="L217">        return mapping;</span>
    }

    /**
     * This method has to be invoked before sending the message.
     * It listens for incoming messages.
     *
     * @throws IOException - if an IO operation exception occurs while starting the listener.
     */
//    @Override
    public void start() throws IOException {
<span class="nc" id="L228">        transport.listen();</span>
<span class="nc" id="L229">    }</span>

    /**
     * Stops the thread, which is listening for the incoming messages and releases all bound resources synchronously.
     *
     * @throws IOException - if any IO operation for the close fails.
     */
//    @Override
    public void stop() throws IOException {
<span class="nc" id="L238">        transport.close();</span>
<span class="nc" id="L239">    }</span>


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>